

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Reinforcement Learning Tips and Tricks &mdash; NEORL 1.1.3b documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> NEORL
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                main (1.1.3b )
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">General Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Getting Started</a></li>
</ul>
<p class="caption"><span class="caption-text">Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/a2c.html">Advantage Actor Critic (A2C)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/dqn.html">Deep Q Learning (DQN)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/ppo2.html">Proximal Policy Optimisation (PPO)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/ga.html">Genetic Algorithms (GA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/es.html">Evolution Strategies (ES)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/pso.html">Particle Swarm Optimisation (PSO)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/de.html">Differential Evolution (DE)</a></li>
</ul>
<p class="caption"><span class="caption-text">Hyperparameter Tuning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tune/grid.html">Grid Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tune/random.html">Random Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tune/evolu.html">Evolutionary Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tune/bayes.html">Bayesian Search</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/ex1.html">Example 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/ex2.html">Example 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/ex3.html">Example 3</a></li>
</ul>
<p class="caption"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/projects.html">Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/contrib.html">Contributors</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NEORL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Reinforcement Learning Tips and Tricks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/guide/rl_tips.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="reinforcement-learning-tips-and-tricks">
<span id="rl-tips"></span><h1>Reinforcement Learning Tips and Tricks<a class="headerlink" href="#reinforcement-learning-tips-and-tricks" title="Permalink to this headline">¶</a></h1>
<p>The aim of this section is to help you doing reinforcement learning experiments.
It covers general advice about RL (where to start, which algorithm to choose, how to evaluate an algorithm, …),
as well as tips and tricks when using a custom environment or implementing an RL algorithm.</p>
<div class="section" id="general-advice-when-using-reinforcement-learning">
<h2>General advice when using Reinforcement Learning<a class="headerlink" href="#general-advice-when-using-reinforcement-learning" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tl-dr">
<h3>TL;DR<a class="headerlink" href="#tl-dr" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Read about RL and Stable Baselines</p></li>
<li><p>Do quantitative experiments and hyperparameter tuning if needed</p></li>
<li><p>Evaluate the performance using a separate test environment</p></li>
<li><p>For better performance, increase the training budget</p></li>
</ol>
<p>Like any other subject, if you want to work with RL, you should first read about it (we have a dedicated <a class="reference external" href="rl.html">resource page</a> to get you started)
to understand what you are using. We also recommend you read Stable Baselines (SB) documentation and do the <a class="reference external" href="https://github.com/araffin/rl-tutorial-jnrr19">tutorial</a>.
It covers basic usage and guide you towards more advanced concepts of the library (e.g. callbacks and wrappers).</p>
<p>Reinforcement Learning differs from other machine learning methods in several ways. The data used to train the agent is collected
through interactions with the environment by the agent itself (compared to supervised learning where you have a fixed dataset for instance).
This dependence can lead to vicious circle: if the agent collects poor quality data (e.g., trajectories with no rewards), then it will not improve and continue to amass
bad trajectories.</p>
<p>This factor, among others, explains that results in RL may vary from one run to another (i.e., when only the seed of the pseudo-random generator changes).
For this reason, you should always do several runs to have quantitative results.</p>
<p>Good results in RL are generally dependent on finding appropriate hyperparameters. Recent algorithms (PPO, SAC, TD3) normally require little hyperparameter tuning,
however, <em>don’t expect the default ones to work</em> on any environment.</p>
<p>Therefore, we <em>highly recommend you</em> to take a look at the <a class="reference external" href="https://github.com/araffin/rl-baselines-zoo">RL zoo</a> (or the original papers) for tuned hyperparameters.
A best practice when you apply RL to a new problem is to do automatic hyperparameter optimization. Again, this is included in the <a class="reference external" href="https://github.com/araffin/rl-baselines-zoo">RL zoo</a>.</p>
<p>When applying RL to a custom problem, you should always normalize the input to the agent (e.g. using VecNormalize for PPO2/A2C)
and look at common preprocessing done on other environments (e.g. for <a class="reference external" href="https://danieltakeshi.github.io/2016/11/25/frame-skipping-and-preprocessing-for-deep-q-networks-on-atari-2600-games/">Atari</a>, frame-stack, …).
Please refer to <em>Tips and Tricks when creating a custom environment</em> paragraph below for more advice related to custom environments.</p>
</div>
<div class="section" id="current-limitations-of-rl">
<h3>Current Limitations of RL<a class="headerlink" href="#current-limitations-of-rl" title="Permalink to this headline">¶</a></h3>
<p>You have to be aware of the current <a class="reference external" href="https://www.alexirpan.com/2018/02/14/rl-hard.html">limitations</a> of reinforcement learning.</p>
<p>Model-free RL algorithms (i.e. all the algorithms implemented in SB) are usually <em>sample inefficient</em>. They require a lot of samples (sometimes millions of interactions) to learn something useful.
That’s why most of the successes in RL were achieved on games or in simulation only. For instance, in this <a class="reference external" href="https://www.youtube.com/watch?v=aTDkYFZFWug">work</a> by ETH Zurich, the ANYmal robot was trained in simulation only, and then tested in the real world.</p>
<p>As a general advice, to obtain better performances, you should augment the budget of the agent (number of training timesteps).</p>
<p>In order to achieve the desired behavior, expert knowledge is often required to design an adequate reward function.
This <em>reward engineering</em> (or <em>RewArt</em> as coined by <a class="reference external" href="http://www.freekstulp.net/">Freek Stulp</a>), necessitates several iterations. As a good example of reward shaping,
you can take a look at <a class="reference external" href="https://xbpeng.github.io/projects/DeepMimic/index.html">Deep Mimic paper</a> which combines imitation learning and reinforcement learning to do acrobatic moves.</p>
<p>One last limitation of RL is the instability of training. That is to say, you can observe during training a huge drop in performance.
This behavior is particularly present in <code class="docutils literal notranslate"><span class="pre">DDPG</span></code>, that’s why its extension <code class="docutils literal notranslate"><span class="pre">TD3</span></code> tries to tackle that issue.
Other method, like <code class="docutils literal notranslate"><span class="pre">TRPO</span></code> or <code class="docutils literal notranslate"><span class="pre">PPO</span></code> make use of a <em>trust region</em> to minimize that problem by avoiding too large update.</p>
</div>
<div class="section" id="how-to-evaluate-an-rl-algorithm">
<h3>How to evaluate an RL algorithm?<a class="headerlink" href="#how-to-evaluate-an-rl-algorithm" title="Permalink to this headline">¶</a></h3>
<p>Because most algorithms use exploration noise during training, you need a separate test environment to evaluate the performance
of your agent at a given time. It is recommended to periodically evaluate your agent for <code class="docutils literal notranslate"><span class="pre">n</span></code> test episodes (<code class="docutils literal notranslate"><span class="pre">n</span></code> is usually between 5 and 20)
and average the reward per episode to have a good estimate.</p>
<p>As some policy are stochastic by default (e.g. A2C or PPO), you should also try to set <cite>deterministic=True</cite> when calling the <cite>.predict()</cite> method,
this frequently leads to better performance.
Looking at the training curve (episode reward function of the timesteps) is a good proxy but underestimates the agent true performance.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We provide an <code class="docutils literal notranslate"><span class="pre">EvalCallback</span></code> for doing such evaluation. You can read more about it in the <a class="reference internal" href="callbacks.html#callbacks"><span class="std std-ref">Callbacks</span></a> section.</p>
</div>
<p>We suggest you reading <a class="reference external" href="https://arxiv.org/abs/1709.06560">Deep Reinforcement Learning that Matters</a> for a good discussion about RL evaluation.</p>
<p>You can also take a look at this <a class="reference external" href="https://openlab-flowers.inria.fr/t/how-many-random-seeds-should-i-use-statistical-power-analysis-in-deep-reinforcement-learning-experiments/457">blog post</a>
and this <a class="reference external" href="https://github.com/hill-a/stable-baselines/issues/199">issue</a> by Cédric Colas.</p>
</div>
</div>
<div class="section" id="which-algorithm-should-i-use">
<h2>Which algorithm should I use?<a class="headerlink" href="#which-algorithm-should-i-use" title="Permalink to this headline">¶</a></h2>
<p>There is no silver bullet in RL, depending on your needs and problem, you may choose one or the other.
The first distinction comes from your action space, i.e., do you have discrete (e.g. LEFT, RIGHT, …)
or continuous actions (ex: go to a certain speed)?</p>
<p>Some algorithms are only tailored for one or the other domain: <code class="docutils literal notranslate"><span class="pre">DQN</span></code> only supports discrete actions, where <code class="docutils literal notranslate"><span class="pre">SAC</span></code> is restricted to continuous actions.</p>
<p>The second difference that will help you choose is whether you can parallelize your training or not, and how you can do it (with or without MPI?).
If what matters is the wall clock training time, then you should lean towards <code class="docutils literal notranslate"><span class="pre">A2C</span></code> and its derivatives (PPO, ACER, ACKTR, …).
Take a look at the <a class="reference external" href="vec_envs.html">Vectorized Environments</a> to learn more about training with multiple workers.</p>
<p>To sum it up:</p>
<div class="section" id="discrete-actions">
<h3>Discrete Actions<a class="headerlink" href="#discrete-actions" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This covers <code class="docutils literal notranslate"><span class="pre">Discrete</span></code>, <code class="docutils literal notranslate"><span class="pre">MultiDiscrete</span></code>, <code class="docutils literal notranslate"><span class="pre">Binary</span></code> and <code class="docutils literal notranslate"><span class="pre">MultiBinary</span></code> spaces</p>
</div>
<div class="section" id="discrete-actions-single-process">
<h4>Discrete Actions - Single Process<a class="headerlink" href="#discrete-actions-single-process" title="Permalink to this headline">¶</a></h4>
<p>DQN with extensions (double DQN, prioritized replay, …) and ACER are the recommended algorithms.
DQN is usually slower to train (regarding wall clock time) but is the most sample efficient (because of its replay buffer).</p>
</div>
<div class="section" id="discrete-actions-multiprocessed">
<h4>Discrete Actions - Multiprocessed<a class="headerlink" href="#discrete-actions-multiprocessed" title="Permalink to this headline">¶</a></h4>
<p>You should give a try to PPO2, A2C and its successors (ACKTR, ACER).</p>
<p>If you can multiprocess the training using MPI, then you should checkout PPO1 and TRPO.</p>
</div>
</div>
<div class="section" id="continuous-actions">
<h3>Continuous Actions<a class="headerlink" href="#continuous-actions" title="Permalink to this headline">¶</a></h3>
<div class="section" id="continuous-actions-single-process">
<h4>Continuous Actions - Single Process<a class="headerlink" href="#continuous-actions-single-process" title="Permalink to this headline">¶</a></h4>
<p>Current State Of The Art (SOTA) algorithms are <code class="docutils literal notranslate"><span class="pre">SAC</span></code> and <code class="docutils literal notranslate"><span class="pre">TD3</span></code>.
Please use the hyperparameters in the <a class="reference external" href="https://github.com/araffin/rl-baselines-zoo">RL zoo</a> for best results.</p>
</div>
<div class="section" id="continuous-actions-multiprocessed">
<h4>Continuous Actions - Multiprocessed<a class="headerlink" href="#continuous-actions-multiprocessed" title="Permalink to this headline">¶</a></h4>
<p>Take a look at PPO2, TRPO or A2C. Again, don’t forget to take the hyperparameters from the <a class="reference external" href="https://github.com/araffin/rl-baselines-zoo">RL zoo</a>
for continuous actions problems (cf <em>Bullet</em> envs).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Normalization is critical for those algorithms</p>
</div>
<p>If you can use MPI, then you can choose between PPO1, TRPO and DDPG.</p>
</div>
</div>
<div class="section" id="goal-environment">
<h3>Goal Environment<a class="headerlink" href="#goal-environment" title="Permalink to this headline">¶</a></h3>
<p>If your environment follows the <code class="docutils literal notranslate"><span class="pre">GoalEnv</span></code> interface (cf <a class="reference external" href="../modules/her.html">HER</a>), then you should use
HER + (SAC/TD3/DDPG/DQN) depending on the action space.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The number of workers is an important hyperparameters for experiments with HER. Currently, only HER+DDPG supports multiprocessing using MPI.</p>
</div>
</div>
</div>
<div class="section" id="tips-and-tricks-when-creating-a-custom-environment">
<h2>Tips and Tricks when creating a custom environment<a class="headerlink" href="#tips-and-tricks-when-creating-a-custom-environment" title="Permalink to this headline">¶</a></h2>
<p>If you want to learn about how to create a custom environment, we recommend you read this <a class="reference external" href="custom_env.html">page</a>.
We also provide a <a class="reference external" href="https://colab.research.google.com/github/araffin/rl-tutorial-jnrr19/blob/master/5_custom_gym_env.ipynb">colab notebook</a> for
a concrete example of creating a custom gym environment.</p>
<p>Some basic advice:</p>
<ul class="simple">
<li><p>always normalize your observation space when you can, i.e., when you know the boundaries</p></li>
<li><p>normalize your action space and make it symmetric when continuous (cf potential issue below) A good practice is to rescale your actions to lie in [-1, 1]. This does not limit you as you can easily rescale the action inside the environment</p></li>
<li><p>start with shaped reward (i.e. informative reward) and simplified version of your problem</p></li>
<li><p>debug with random actions to check that your environment works and follows the gym interface:</p></li>
</ul>
<p>We provide a helper to check that your environment runs without error:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">stable_baselines.common.env_checker</span> <span class="kn">import</span> <span class="n">check_env</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">CustomEnv</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="c1"># It will check your custom environment and output additional warnings if needed</span>
<span class="n">check_env</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to quickly try a random agent on your environment, you can also do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">YourEnv</span><span class="p">()</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
    <span class="c1"># Random action</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Why should I normalize the action space?</strong></p>
<p>Most reinforcement learning algorithms rely on a Gaussian distribution (initially centered at 0 with std 1) for continuous actions.
So, if you forget to normalize the action space when using a custom environment,
this can harm learning and be difficult to debug (cf attached image and <a class="reference external" href="https://github.com/hill-a/stable-baselines/issues/473">issue #473</a>).</p>
<div class="figure align-default">
<img alt="../_images/mistake.png" src="../_images/mistake.png" />
</div>
<p>Another consequence of using a Gaussian is that the action range is not bounded.
That’s why clipping is usually used as a bandage to stay in a valid interval.
A better solution would be to use a squashing function (cf <code class="docutils literal notranslate"><span class="pre">SAC</span></code>) or a Beta distribution (cf <a class="reference external" href="https://github.com/hill-a/stable-baselines/issues/112">issue #112</a>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This statement is not true for <code class="docutils literal notranslate"><span class="pre">DDPG</span></code> or <code class="docutils literal notranslate"><span class="pre">TD3</span></code> because they don’t rely on any probability distribution.</p>
</div>
</div>
<div class="section" id="tips-and-tricks-when-implementing-an-rl-algorithm">
<h2>Tips and Tricks when implementing an RL algorithm<a class="headerlink" href="#tips-and-tricks-when-implementing-an-rl-algorithm" title="Permalink to this headline">¶</a></h2>
<p>When you try to reproduce a RL paper by implementing the algorithm, the <a class="reference external" href="http://joschu.net/docs/nuts-and-bolts.pdf">nuts and bolts of RL research</a>
by John Schulman are quite useful (<a class="reference external" href="https://www.youtube.com/watch?v=8EcdaCk9KaQ">video</a>).</p>
<p>We <em>recommend following those steps to have a working RL algorithm</em>:</p>
<ol class="arabic simple">
<li><p>Read the original paper several times</p></li>
<li><p>Read existing implementations (if available)</p></li>
<li><p>Try to have some “sign of life” on toy problems</p></li>
<li><dl class="simple">
<dt>Validate the implementation by making it run on harder and harder envs (you can compare results against the RL zoo)</dt><dd><p>You usually need to run hyperparameter optimization for that step.</p>
</dd>
</dl>
</li>
</ol>
<p>You need to be particularly careful on the shape of the different objects you are manipulating (a broadcast mistake will fail silently cf <a class="reference external" href="https://github.com/hill-a/stable-baselines/pull/76">issue #75</a>)
and when to stop the gradient propagation.</p>
<p>A personal pick (by &#64;araffin) for environments with gradual difficulty in RL with continuous actions:</p>
<ol class="arabic simple">
<li><p>Pendulum (easy to solve)</p></li>
<li><p>HalfCheetahBullet (medium difficulty with local minima and shaped reward)</p></li>
<li><p>BipedalWalkerHardcore (if it works on that one, then you can have a cookie)</p></li>
</ol>
<p>in RL with discrete actions:</p>
<ol class="arabic simple">
<li><p>CartPole-v1 (easy to be better than random agent, harder to achieve maximal performance)</p></li>
<li><p>LunarLander</p></li>
<li><p>Pong (one of the easiest Atari game)</p></li>
<li><p>other Atari games (e.g. Breakout)</p></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Exelon Corp. &amp; MIT.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>