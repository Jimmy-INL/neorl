

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Callbacks &mdash; NEORL 1.1.3b documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> NEORL
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                main (1.1.3b )
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">General Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Getting Started</a></li>
</ul>
<p class="caption"><span class="caption-text">Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/a2c.html">Advantage Actor Critic (A2C)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/dqn.html">Deep Q Learning (DQN)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/ppo2.html">Proximal Policy Optimisation (PPO)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/es.html">Evolution Strategies (ES)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/pso.html">Particle Swarm Optimisation (PSO)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/de.html">Differential Evolution (DE)</a></li>
</ul>
<p class="caption"><span class="caption-text">Hyperparameter Tuning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tune/grid.html">Grid Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tune/random.html">Random Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tune/evolu.html">Evolutionary Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tune/bayes.html">Bayesian Search</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/ex1.html">Example 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/ex2.html">Example 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/ex3.html">Example 3</a></li>
</ul>
<p class="caption"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/projects.html">Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/contrib.html">Contributors</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NEORL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Callbacks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/guide/callbacks.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="callbacks">
<span id="id1"></span><h1>Callbacks<a class="headerlink" href="#callbacks" title="Permalink to this headline">¶</a></h1>
<p>A callback is a set of functions that will be called at given stages of the training procedure.
You can use callbacks to access internal state of the RL model during training.
It allows one to do monitoring, auto saving, model manipulation, progress bars, …</p>
<div class="section" id="custom-callback">
<h2>Custom Callback<a class="headerlink" href="#custom-callback" title="Permalink to this headline">¶</a></h2>
<p>To build a custom callback, you need to create a class that derives from <code class="docutils literal notranslate"><span class="pre">BaseCallback</span></code>.
This will give you access to events (<code class="docutils literal notranslate"><span class="pre">_on_training_start</span></code>, <code class="docutils literal notranslate"><span class="pre">_on_step</span></code>) and useful variables (like <cite>self.model</cite> for the RL model).</p>
<p>You can find two examples of custom callbacks in the documentation: one for saving the best model according to the training reward (see <a class="reference internal" href="examples.html#examples"><span class="std std-ref">Examples</span></a>), and one for logging additional values with Tensorboard (see <a class="reference internal" href="tensorboard.html#tensorboard"><span class="std std-ref">Tensorboard section</span></a>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">stable_baselines.common.callbacks</span> <span class="kn">import</span> <span class="n">BaseCallback</span>


<span class="k">class</span> <span class="nc">CustomCallback</span><span class="p">(</span><span class="n">BaseCallback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom callback that derives from ``BaseCallback``.</span>

<span class="sd">    :param verbose: (int) Verbosity level 0: not output 1: info 2: debug</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CustomCallback</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
        <span class="c1"># Those variables will be accessible in the callback</span>
        <span class="c1"># (they are defined in the base class)</span>
        <span class="c1"># The RL model</span>
        <span class="c1"># self.model = None  # type: BaseRLModel</span>
        <span class="c1"># An alias for self.model.get_env(), the environment used for training</span>
        <span class="c1"># self.training_env = None  # type: Union[gym.Env, VecEnv, None]</span>
        <span class="c1"># Number of time the callback was called</span>
        <span class="c1"># self.n_calls = 0  # type: int</span>
        <span class="c1"># self.num_timesteps = 0  # type: int</span>
        <span class="c1"># local and global variables</span>
        <span class="c1"># self.locals = None  # type: Dict[str, Any]</span>
        <span class="c1"># self.globals = None  # type: Dict[str, Any]</span>
        <span class="c1"># The logger object, used to report things in the terminal</span>
        <span class="c1"># self.logger = None  # type: logger.Logger</span>
        <span class="c1"># # Sometimes, for event callback, it is useful</span>
        <span class="c1"># # to have access to the parent object</span>
        <span class="c1"># self.parent = None  # type: Optional[BaseCallback]</span>

    <span class="k">def</span> <span class="nf">_on_training_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called before the first rollout starts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_on_rollout_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A rollout is the collection of environment interaction</span>
<span class="sd">        using the current policy.</span>
<span class="sd">        This event is triggered before collecting new samples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_on_step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will be called by the model after each call to `env.step()`.</span>

<span class="sd">        For child callback (of an `EventCallback`), this will be called</span>
<span class="sd">        when the event is triggered.</span>

<span class="sd">        :return: (bool) If the callback returns False, training is aborted early.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_on_rollout_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This event is triggered before updating the policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_on_training_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This event is triggered before exiting the `learn()` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><cite>self.num_timesteps</cite> corresponds to the total number of steps taken in the environment, i.e., it is the number of environments multiplied by the number of time <cite>env.step()</cite> was called</p>
<p>You should know that <code class="docutils literal notranslate"><span class="pre">PPO1</span></code> and <code class="docutils literal notranslate"><span class="pre">TRPO</span></code> update <cite>self.num_timesteps</cite> after each rollout (and not each step) because they rely on MPI.</p>
<p>For the other algorithms, <cite>self.num_timesteps</cite> is incremented by <code class="docutils literal notranslate"><span class="pre">n_envs</span></code> (number of environments) after each call to <cite>env.step()</cite></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For off-policy algorithms like SAC, DDPG, TD3 or DQN, the notion of <code class="docutils literal notranslate"><span class="pre">rollout</span></code> corresponds to the steps taken in the environment between two updates.</p>
</div>
</div>
<div class="section" id="event-callback">
<span id="eventcallback"></span><h2>Event Callback<a class="headerlink" href="#event-callback" title="Permalink to this headline">¶</a></h2>
<p>Compared to Keras, Stable Baselines provides a second type of <code class="docutils literal notranslate"><span class="pre">BaseCallback</span></code>, named <code class="docutils literal notranslate"><span class="pre">EventCallback</span></code> that is meant to trigger events. When an event is triggered, then a child callback is called.</p>
<p>As an example, <a class="reference internal" href="#evalcallback"><span class="std std-ref">EvalCallback</span></a> is an <code class="docutils literal notranslate"><span class="pre">EventCallback</span></code> that will trigger its child callback when there is a new best model.
A child callback is for instance <a class="reference internal" href="#stoptrainingcallback"><span class="std std-ref">StopTrainingOnRewardThreshold</span></a> that stops the training if the mean reward achieved by the RL model is above a threshold.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We recommend to take a look at the source code of <a class="reference internal" href="#evalcallback"><span class="std std-ref">EvalCallback</span></a> and <a class="reference internal" href="#stoptrainingcallback"><span class="std std-ref">StopTrainingOnRewardThreshold</span></a> to have a better overview of what can be achieved with this kind of callbacks.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EventCallback</span><span class="p">(</span><span class="n">BaseCallback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for triggering callback on event.</span>

<span class="sd">    :param callback: (Optional[BaseCallback]) Callback that will be called</span>
<span class="sd">        when an event is triggered.</span>
<span class="sd">    :param verbose: (int)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseCallback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EventCallback</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="c1"># Give access to the parent</span>
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">_on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="section" id="callback-collection">
<h2>Callback Collection<a class="headerlink" href="#callback-collection" title="Permalink to this headline">¶</a></h2>
<p>Stable Baselines provides you with a set of common callbacks for:</p>
<ul class="simple">
<li><p>saving the model periodically (<a class="reference internal" href="#checkpointcallback"><span class="std std-ref">CheckpointCallback</span></a>)</p></li>
<li><p>evaluating the model periodically and saving the best one (<a class="reference internal" href="#evalcallback"><span class="std std-ref">EvalCallback</span></a>)</p></li>
<li><p>chaining callbacks (<a class="reference internal" href="#callbacklist"><span class="std std-ref">CallbackList</span></a>)</p></li>
<li><p>triggering callback on events (<a class="reference internal" href="#eventcallback"><span class="std std-ref">Event Callback</span></a>, <a class="reference internal" href="#everyntimesteps"><span class="std std-ref">EveryNTimesteps</span></a>)</p></li>
<li><p>stopping the training early based on a reward threshold (<a class="reference internal" href="#stoptrainingcallback"><span class="std std-ref">StopTrainingOnRewardThreshold</span></a>)</p></li>
</ul>
<div class="section" id="checkpointcallback">
<span id="id2"></span><h3>CheckpointCallback<a class="headerlink" href="#checkpointcallback" title="Permalink to this headline">¶</a></h3>
<p>Callback for saving a model every <code class="docutils literal notranslate"><span class="pre">save_freq</span></code> steps, you must specify a log folder (<code class="docutils literal notranslate"><span class="pre">save_path</span></code>)
and optionally a prefix for the checkpoints (<code class="docutils literal notranslate"><span class="pre">rl_model</span></code> by default).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">stable_baselines</span> <span class="kn">import</span> <span class="n">SAC</span>
<span class="kn">from</span> <span class="nn">stable_baselines.common.callbacks</span> <span class="kn">import</span> <span class="n">CheckpointCallback</span>
<span class="c1"># Save a checkpoint every 1000 steps</span>
<span class="n">checkpoint_callback</span> <span class="o">=</span> <span class="n">CheckpointCallback</span><span class="p">(</span><span class="n">save_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;./logs/&#39;</span><span class="p">,</span>
                                         <span class="n">name_prefix</span><span class="o">=</span><span class="s1">&#39;rl_model&#39;</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">SAC</span><span class="p">(</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span> <span class="s1">&#39;Pendulum-v0&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">checkpoint_callback</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="evalcallback">
<span id="id3"></span><h3>EvalCallback<a class="headerlink" href="#evalcallback" title="Permalink to this headline">¶</a></h3>
<p>Evaluate periodically the performance of an agent, using a separate test environment.
It will save the best model if <code class="docutils literal notranslate"><span class="pre">best_model_save_path</span></code> folder is specified and save the evaluations results in a numpy archive (<cite>evaluations.npz</cite>) if <code class="docutils literal notranslate"><span class="pre">log_path</span></code> folder is specified.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can pass a child callback via the <code class="docutils literal notranslate"><span class="pre">callback_on_new_best</span></code> argument. It will be triggered each time there is a new best model.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gym</span>

<span class="kn">from</span> <span class="nn">stable_baselines</span> <span class="kn">import</span> <span class="n">SAC</span>
<span class="kn">from</span> <span class="nn">stable_baselines.common.callbacks</span> <span class="kn">import</span> <span class="n">EvalCallback</span>

<span class="c1"># Separate evaluation env</span>
<span class="n">eval_env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;Pendulum-v0&#39;</span><span class="p">)</span>
<span class="c1"># Use deterministic actions for evaluation</span>
<span class="n">eval_callback</span> <span class="o">=</span> <span class="n">EvalCallback</span><span class="p">(</span><span class="n">eval_env</span><span class="p">,</span> <span class="n">best_model_save_path</span><span class="o">=</span><span class="s1">&#39;./logs/&#39;</span><span class="p">,</span>
                             <span class="n">log_path</span><span class="o">=</span><span class="s1">&#39;./logs/&#39;</span><span class="p">,</span> <span class="n">eval_freq</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                             <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">SAC</span><span class="p">(</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span> <span class="s1">&#39;Pendulum-v0&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">eval_callback</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="callbacklist">
<span id="id4"></span><h3>CallbackList<a class="headerlink" href="#callbacklist" title="Permalink to this headline">¶</a></h3>
<p>Class for chaining callbacks, they will be called sequentially.
Alternatively, you can pass directly a list of callbacks to the <cite>learn()</cite> method, it will be converted automatically to a <code class="docutils literal notranslate"><span class="pre">CallbackList</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gym</span>

<span class="kn">from</span> <span class="nn">stable_baselines</span> <span class="kn">import</span> <span class="n">SAC</span>
<span class="kn">from</span> <span class="nn">stable_baselines.common.callbacks</span> <span class="kn">import</span> <span class="n">CallbackList</span><span class="p">,</span> <span class="n">CheckpointCallback</span><span class="p">,</span> <span class="n">EvalCallback</span>

<span class="n">checkpoint_callback</span> <span class="o">=</span> <span class="n">CheckpointCallback</span><span class="p">(</span><span class="n">save_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;./logs/&#39;</span><span class="p">)</span>
<span class="c1"># Separate evaluation env</span>
<span class="n">eval_env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;Pendulum-v0&#39;</span><span class="p">)</span>
<span class="n">eval_callback</span> <span class="o">=</span> <span class="n">EvalCallback</span><span class="p">(</span><span class="n">eval_env</span><span class="p">,</span> <span class="n">best_model_save_path</span><span class="o">=</span><span class="s1">&#39;./logs/best_model&#39;</span><span class="p">,</span>
                             <span class="n">log_path</span><span class="o">=</span><span class="s1">&#39;./logs/results&#39;</span><span class="p">,</span> <span class="n">eval_freq</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="c1"># Create the callback list</span>
<span class="n">callback</span> <span class="o">=</span> <span class="n">CallbackList</span><span class="p">([</span><span class="n">checkpoint_callback</span><span class="p">,</span> <span class="n">eval_callback</span><span class="p">])</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">SAC</span><span class="p">(</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span> <span class="s1">&#39;Pendulum-v0&#39;</span><span class="p">)</span>
<span class="c1"># Equivalent to:</span>
<span class="c1"># model.learn(5000, callback=[checkpoint_callback, eval_callback])</span>
<span class="n">model</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="stoptrainingonrewardthreshold">
<span id="stoptrainingcallback"></span><h3>StopTrainingOnRewardThreshold<a class="headerlink" href="#stoptrainingonrewardthreshold" title="Permalink to this headline">¶</a></h3>
<p>Stop the training once a threshold in episodic reward (mean episode reward over the evaluations) has been reached (i.e., when the model is good enough).
It must be used with the <a class="reference internal" href="#evalcallback"><span class="std std-ref">EvalCallback</span></a> and use the event triggered by a new best model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gym</span>

<span class="kn">from</span> <span class="nn">stable_baselines</span> <span class="kn">import</span> <span class="n">SAC</span>
<span class="kn">from</span> <span class="nn">stable_baselines.common.callbacks</span> <span class="kn">import</span> <span class="n">EvalCallback</span><span class="p">,</span> <span class="n">StopTrainingOnRewardThreshold</span>

<span class="c1"># Separate evaluation env</span>
<span class="n">eval_env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;Pendulum-v0&#39;</span><span class="p">)</span>
<span class="c1"># Stop training when the model reaches the reward threshold</span>
<span class="n">callback_on_best</span> <span class="o">=</span> <span class="n">StopTrainingOnRewardThreshold</span><span class="p">(</span><span class="n">reward_threshold</span><span class="o">=-</span><span class="mi">200</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">eval_callback</span> <span class="o">=</span> <span class="n">EvalCallback</span><span class="p">(</span><span class="n">eval_env</span><span class="p">,</span> <span class="n">callback_on_new_best</span><span class="o">=</span><span class="n">callback_on_best</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">SAC</span><span class="p">(</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span> <span class="s1">&#39;Pendulum-v0&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Almost infinite number of timesteps, but the training will stop</span>
<span class="c1"># early as soon as the reward threshold is reached</span>
<span class="n">model</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e10</span><span class="p">),</span> <span class="n">callback</span><span class="o">=</span><span class="n">eval_callback</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="everyntimesteps">
<span id="id5"></span><h3>EveryNTimesteps<a class="headerlink" href="#everyntimesteps" title="Permalink to this headline">¶</a></h3>
<p>An <a class="reference internal" href="#eventcallback"><span class="std std-ref">Event Callback</span></a> that will trigger its child callback every <code class="docutils literal notranslate"><span class="pre">n_steps</span></code> timesteps.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because of the way <code class="docutils literal notranslate"><span class="pre">PPO1</span></code> and <code class="docutils literal notranslate"><span class="pre">TRPO</span></code> work (they rely on MPI), <code class="docutils literal notranslate"><span class="pre">n_steps</span></code> is a lower bound between two events.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gym</span>

<span class="kn">from</span> <span class="nn">stable_baselines</span> <span class="kn">import</span> <span class="n">PPO2</span>
<span class="kn">from</span> <span class="nn">stable_baselines.common.callbacks</span> <span class="kn">import</span> <span class="n">CheckpointCallback</span><span class="p">,</span> <span class="n">EveryNTimesteps</span>

<span class="c1"># this is equivalent to defining CheckpointCallback(save_freq=500)</span>
<span class="c1"># checkpoint_callback will be triggered every 500 steps</span>
<span class="n">checkpoint_on_event</span> <span class="o">=</span> <span class="n">CheckpointCallback</span><span class="p">(</span><span class="n">save_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;./logs/&#39;</span><span class="p">)</span>
<span class="n">event_callback</span> <span class="o">=</span> <span class="n">EveryNTimesteps</span><span class="p">(</span><span class="n">n_steps</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">checkpoint_on_event</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">PPO2</span><span class="p">(</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span> <span class="s1">&#39;Pendulum-v0&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">2e4</span><span class="p">),</span> <span class="n">callback</span><span class="o">=</span><span class="n">event_callback</span><span class="p">)</span>
</pre></div>
</div>
<span class="target" id="module-stable_baselines.common.callbacks"></span><div class="section" id="legacy-a-functional-approach">
<h4>Legacy: A functional approach<a class="headerlink" href="#legacy-a-functional-approach" title="Permalink to this headline">¶</a></h4>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This way of doing callbacks is deprecated in favor of the object oriented approach.</p>
</div>
<p>A callback function takes the <code class="docutils literal notranslate"><span class="pre">locals()</span></code> variables and the <code class="docutils literal notranslate"><span class="pre">globals()</span></code> variables from the model, then returns a boolean value for whether or not the training should continue.</p>
<p>Thanks to the access to the models variables, in particular <code class="docutils literal notranslate"><span class="pre">_locals[&quot;self&quot;]</span></code>, we are able to even change the parameters of the model without halting the training, or changing the model’s code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">from</span> <span class="nn">stable_baselines</span> <span class="kn">import</span> <span class="n">PPO2</span>


<span class="k">def</span> <span class="nf">simple_callback</span><span class="p">(</span><span class="n">_locals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">_globals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callback called at each step (for DQN and others) or after n steps (see ACER or PPO2).</span>
<span class="sd">    This callback will save the model and stop the training after the first call.</span>

<span class="sd">    :param _locals: (Dict[str, Any])</span>
<span class="sd">    :param _globals: (Dict[str, Any])</span>
<span class="sd">    :return: (bool) If your callback returns False, training is aborted early.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;callback called&quot;</span><span class="p">)</span>
    <span class="c1"># Save the model</span>
    <span class="n">_locals</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;saved_model&quot;</span><span class="p">)</span>
    <span class="c1"># If you want to continue training, the callback must return True.</span>
    <span class="c1"># return True # returns True, training continues.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;stop training&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span> <span class="c1"># returns False, training stops.</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">PPO2</span><span class="p">(</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span> <span class="s1">&#39;CartPole-v1&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">simple_callback</span><span class="p">)</span>
</pre></div>
</div>
<dl class="class">
<dt id="stable_baselines.common.callbacks.BaseCallback">
<em class="property">class </em><code class="sig-prename descclassname">stable_baselines.common.callbacks.</code><code class="sig-name descname">BaseCallback</code><span class="sig-paren">(</span><em class="sig-param">verbose: int = 0</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/stable_baselines/common/callbacks.html#BaseCallback"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#stable_baselines.common.callbacks.BaseCallback" title="Permalink to this definition">¶</a></dt>
<dd><p>Base class for callback.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>verbose</strong> – (int)</p>
</dd>
</dl>
<dl class="method">
<dt id="stable_baselines.common.callbacks.BaseCallback.init_callback">
<code class="sig-name descname">init_callback</code><span class="sig-paren">(</span><em class="sig-param">model: BaseRLModel</em><span class="sig-paren">)</span> &#x2192; None<a class="reference internal" href="../_modules/stable_baselines/common/callbacks.html#BaseCallback.init_callback"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#stable_baselines.common.callbacks.BaseCallback.init_callback" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize the callback by saving references to the
RL model and the training environment for convenience.</p>
</dd></dl>

<dl class="method">
<dt id="stable_baselines.common.callbacks.BaseCallback.on_step">
<code class="sig-name descname">on_step</code><span class="sig-paren">(</span><span class="sig-paren">)</span> &#x2192; bool<a class="reference internal" href="../_modules/stable_baselines/common/callbacks.html#BaseCallback.on_step"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#stable_baselines.common.callbacks.BaseCallback.on_step" title="Permalink to this definition">¶</a></dt>
<dd><p>This method will be called by the model after each call to <cite>env.step()</cite>.</p>
<p>For child callback (of an <cite>EventCallback</cite>), this will be called
when the event is triggered.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>(bool) If the callback returns False, training is aborted early.</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="stable_baselines.common.callbacks.CallbackList">
<em class="property">class </em><code class="sig-prename descclassname">stable_baselines.common.callbacks.</code><code class="sig-name descname">CallbackList</code><span class="sig-paren">(</span><em class="sig-param">callbacks: List[stable_baselines.common.callbacks.BaseCallback]</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/stable_baselines/common/callbacks.html#CallbackList"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#stable_baselines.common.callbacks.CallbackList" title="Permalink to this definition">¶</a></dt>
<dd><p>Class for chaining callbacks.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>callbacks</strong> – (List[BaseCallback]) A list of callbacks that will be called
sequentially.</p>
</dd>
</dl>
</dd></dl>

<dl class="class">
<dt id="stable_baselines.common.callbacks.CheckpointCallback">
<em class="property">class </em><code class="sig-prename descclassname">stable_baselines.common.callbacks.</code><code class="sig-name descname">CheckpointCallback</code><span class="sig-paren">(</span><em class="sig-param">save_freq: int</em>, <em class="sig-param">save_path: str</em>, <em class="sig-param">name_prefix='rl_model'</em>, <em class="sig-param">verbose=0</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/stable_baselines/common/callbacks.html#CheckpointCallback"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#stable_baselines.common.callbacks.CheckpointCallback" title="Permalink to this definition">¶</a></dt>
<dd><p>Callback for saving a model every <cite>save_freq</cite> steps</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>save_freq</strong> – (int)</p></li>
<li><p><strong>save_path</strong> – (str) Path to the folder where the model will be saved.</p></li>
<li><p><strong>name_prefix</strong> – (str) Common prefix to the saved models</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="class">
<dt id="stable_baselines.common.callbacks.ConvertCallback">
<em class="property">class </em><code class="sig-prename descclassname">stable_baselines.common.callbacks.</code><code class="sig-name descname">ConvertCallback</code><span class="sig-paren">(</span><em class="sig-param">callback</em>, <em class="sig-param">verbose=0</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/stable_baselines/common/callbacks.html#ConvertCallback"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#stable_baselines.common.callbacks.ConvertCallback" title="Permalink to this definition">¶</a></dt>
<dd><p>Convert functional callback (old-style) to object.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>callback</strong> – (Callable)</p></li>
<li><p><strong>verbose</strong> – (int)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="class">
<dt id="stable_baselines.common.callbacks.EvalCallback">
<em class="property">class </em><code class="sig-prename descclassname">stable_baselines.common.callbacks.</code><code class="sig-name descname">EvalCallback</code><span class="sig-paren">(</span><em class="sig-param">eval_env: Union[gym.core.Env, stable_baselines.common.vec_env.base_vec_env.VecEnv], callback_on_new_best: Optional[stable_baselines.common.callbacks.BaseCallback] = None, n_eval_episodes: int = 5, eval_freq: int = 10000, log_path: str = None, best_model_save_path: str = None, deterministic: bool = True, render: bool = False, verbose: int = 1</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/stable_baselines/common/callbacks.html#EvalCallback"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#stable_baselines.common.callbacks.EvalCallback" title="Permalink to this definition">¶</a></dt>
<dd><p>Callback for evaluating an agent.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>eval_env</strong> – (Union[gym.Env, VecEnv]) The environment used for initialization</p></li>
<li><p><strong>callback_on_new_best</strong> – (Optional[BaseCallback]) Callback to trigger
when there is a new best model according to the <cite>mean_reward</cite></p></li>
<li><p><strong>n_eval_episodes</strong> – (int) The number of episodes to test the agent</p></li>
<li><p><strong>eval_freq</strong> – (int) Evaluate the agent every eval_freq call of the callback.</p></li>
<li><p><strong>log_path</strong> – (str) Path to a folder where the evaluations (<cite>evaluations.npz</cite>)
will be saved. It will be updated at each evaluation.</p></li>
<li><p><strong>best_model_save_path</strong> – (str) Path to a folder where the best model
according to performance on the eval env will be saved.</p></li>
<li><p><strong>deterministic</strong> – (bool) Whether the evaluation should
use a stochastic or deterministic actions.</p></li>
<li><p><strong>render</strong> – (bool) Whether to render or not the environment during evaluation</p></li>
<li><p><strong>verbose</strong> – (int)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="class">
<dt id="stable_baselines.common.callbacks.EventCallback">
<em class="property">class </em><code class="sig-prename descclassname">stable_baselines.common.callbacks.</code><code class="sig-name descname">EventCallback</code><span class="sig-paren">(</span><em class="sig-param">callback: Optional[stable_baselines.common.callbacks.BaseCallback] = None</em>, <em class="sig-param">verbose: int = 0</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/stable_baselines/common/callbacks.html#EventCallback"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#stable_baselines.common.callbacks.EventCallback" title="Permalink to this definition">¶</a></dt>
<dd><p>Base class for triggering callback on event.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>callback</strong> – (Optional[BaseCallback]) Callback that will be called
when an event is triggered.</p></li>
<li><p><strong>verbose</strong> – (int)</p></li>
</ul>
</dd>
</dl>
<dl class="method">
<dt id="stable_baselines.common.callbacks.EventCallback.init_callback">
<code class="sig-name descname">init_callback</code><span class="sig-paren">(</span><em class="sig-param">model: BaseRLModel</em><span class="sig-paren">)</span> &#x2192; None<a class="reference internal" href="../_modules/stable_baselines/common/callbacks.html#EventCallback.init_callback"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#stable_baselines.common.callbacks.EventCallback.init_callback" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize the callback by saving references to the
RL model and the training environment for convenience.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="stable_baselines.common.callbacks.EveryNTimesteps">
<em class="property">class </em><code class="sig-prename descclassname">stable_baselines.common.callbacks.</code><code class="sig-name descname">EveryNTimesteps</code><span class="sig-paren">(</span><em class="sig-param">n_steps: int</em>, <em class="sig-param">callback: stable_baselines.common.callbacks.BaseCallback</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/stable_baselines/common/callbacks.html#EveryNTimesteps"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#stable_baselines.common.callbacks.EveryNTimesteps" title="Permalink to this definition">¶</a></dt>
<dd><p>Trigger a callback every <cite>n_steps</cite> timesteps</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>n_steps</strong> – (int) Number of timesteps between two trigger.</p></li>
<li><p><strong>callback</strong> – (BaseCallback) Callback that will be called
when the event is triggered.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="class">
<dt id="stable_baselines.common.callbacks.StopTrainingOnRewardThreshold">
<em class="property">class </em><code class="sig-prename descclassname">stable_baselines.common.callbacks.</code><code class="sig-name descname">StopTrainingOnRewardThreshold</code><span class="sig-paren">(</span><em class="sig-param">reward_threshold: float</em>, <em class="sig-param">verbose: int = 0</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/stable_baselines/common/callbacks.html#StopTrainingOnRewardThreshold"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#stable_baselines.common.callbacks.StopTrainingOnRewardThreshold" title="Permalink to this definition">¶</a></dt>
<dd><p>Stop the training once a threshold in episodic reward
has been reached (i.e. when the model is good enough).</p>
<p>It must be used with the <cite>EvalCallback</cite>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>reward_threshold</strong> – (float)  Minimum expected reward per episode
to stop training.</p></li>
<li><p><strong>verbose</strong> – (int)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Exelon Corp. &amp; MIT.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>